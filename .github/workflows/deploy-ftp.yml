name: Auto Deploy to CPanel Hosting

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Cho ph√©p ch·∫°y th·ªß c√¥ng t·ª´ GitHub UI

jobs:
  # CI: Continuous Integration - Ki·ªÉm tra code tr∆∞·ªõc khi deploy
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check with Astro
        run: npx astro check

  # CD: Continuous Deployment - Deploy l√™n hosting
  deploy:
    needs: ci  # Ch·ªâ deploy n·∫øu CI pass
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Astro project
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo "Error: dist folder is empty or does not exist!"
            exit 1
          fi
          echo "Build output verified successfully"

      - name: Validate FTP configuration
        run: |
          echo "=== Validating FTP Configuration ==="
          echo "Checking if FTP_HOST secret is set..."
          if [ -z "$FTP_HOST" ]; then
            echo "‚ùå ERROR: FTP_HOST secret is empty or not set!"
            echo "Please check your GitHub Secrets configuration."
            exit 1
          else
            FTP_HOST_LEN=${#FTP_HOST}
            echo "‚úÖ FTP_HOST is set (length: ${FTP_HOST_LEN} characters)"
          fi
          
          echo ""
          echo "Checking if FTP_USER secret is set..."
          if [ -z "$FTP_USER" ]; then
            echo "‚ùå ERROR: FTP_USER secret is empty or not set!"
            exit 1
          else
            FTP_USER_LEN=${#FTP_USER}
            echo "‚úÖ FTP_USER is set (length: ${FTP_USER_LEN} characters)"
          fi
          
          echo ""
          echo "Checking if FTP_PASS secret is set..."
          if [ -z "$FTP_PASS" ]; then
            echo "‚ùå ERROR: FTP_PASS secret is empty or not set!"
            exit 1
          else
            FTP_PASS_LEN=${#FTP_PASS}
            echo "‚úÖ FTP_PASS is set (length: ${FTP_PASS_LEN} characters)"
          fi
          
          echo ""
          echo "=== Validation complete ==="
          echo "All required FTP secrets are configured."
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}

      - name: Debug FTP connection
        continue-on-error: true
        run: |
          echo "=== Debugging FTP Connection ==="
          echo "Testing DNS resolution for: $FTP_HOST"
          if nslookup "$FTP_HOST" 2>&1 | grep -q "can't find\|NXDOMAIN"; then
            echo "‚ö†Ô∏è  WARNING: DNS lookup failed! Hostname cannot be resolved."
            echo "This might cause FTP connection to fail."
            echo ""
            echo "üí° SOLUTION: Use IP address instead of hostname"
            echo "  1. Find the IP address of your FTP server"
            echo "  2. Update FTP_HOST secret with the IP address (e.g., 123.456.789.0)"
            echo "  3. The IP can usually be found in your hosting control panel or by running:"
            echo "     ping $FTP_HOST"
            echo "     or"
            echo "     nslookup $FTP_HOST"
          else
            echo "‚úÖ DNS lookup successful"
            nslookup "$FTP_HOST" | head -10
          fi
          
          echo ""
          echo "=== Debug complete ==="
          echo "Note: FTP deployment will still be attempted even if DNS lookup failed."
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}

      - name: Deploy to cPanel using FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          local-dir: ./dist/
          # FTP user is already rooted at public_html, so use relative path
          # to avoid duplicating the path (it was uploading into /public_html/public_html).
          server-dir: ./                        # ph·∫£i k·∫øt th√∫c b·∫±ng d·∫•u /
          exclude: |
            .github/
            .gitignore
            README.md
            **/.git*
            **/node_modules*
            **/.DS_Store
            **/.env*
            **/*.log
          dangerous-clean-slate: false
          dry-run: false
