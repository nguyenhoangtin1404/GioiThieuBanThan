---
// Language Switcher Component
// Displays a beautiful toggle button for switching between Vietnamese and English
---

<button
  id="lang-switcher"
  class="lang-switcher"
  aria-label="Switch language"
  title="Switch language"
>
  <span class="globe-icon">
    <svg height="16" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="16" class="globe-svg">
      <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM5.78 8.75a9.64 9.64 0 0 0 1.363 4.177c.255.426.542.832.857 1.215.245-.296.551-.705.857-1.215A9.64 9.64 0 0 0 10.22 8.75Zm4.44-1.5a9.64 9.64 0 0 0-1.363-4.177c-.307-.51-.612-.919-.857-1.215a9.927 9.927 0 0 0-.857 1.215A9.64 9.64 0 0 0 5.78 7.25Zm-5.944 1.5H1.543a6.507 6.507 0 0 0 4.666 5.5c-.123-.181-.24-.365-.352-.552-.715-1.192-1.437-2.874-1.581-4.948Zm-2.733-1.5h2.733c.144-2.074.866-3.756 1.58-4.948.12-.197.237-.381.353-.552a6.507 6.507 0 0 0-4.666 5.5Zm10.181 1.5c-.144 2.074-.866 3.756-1.58 4.948-.12.197-.237.381-.353.552a6.507 6.507 0 0 0 4.666-5.5Zm2.733-1.5a6.507 6.507 0 0 0-4.666-5.5c.123.181.24.365.353.552.714 1.192 1.436 2.874 1.58 4.948Z"></path>
    </svg>
  </span>
  <span class="lang-option" data-lang="vi">
    <span class="text">VI</span>
  </span>
  <span class="lang-separator">|</span>
  <span class="lang-option" data-lang="en">
    <span class="text">EN</span>
  </span>
</button>

<script is:inline>
  (function() {
    // Get current language
    function getCurrentLang() {
      if (typeof window === 'undefined') return 'vi';
      const urlParams = new URLSearchParams(window.location.search);
      const langParam = urlParams.get('lang');
      if (langParam === 'vi' || langParam === 'en') return langParam;
      const stored = localStorage.getItem('lang');
      return (stored === 'vi' || stored === 'en') ? stored : 'vi';
    }

    // Set active state
    function setActiveLang(lang) {
      const switcher = document.getElementById('lang-switcher');
      if (!switcher) return;
      
      const options = switcher.querySelectorAll('.lang-option');
      options.forEach(opt => {
        if (opt.dataset.lang === lang) {
          opt.classList.add('active');
        } else {
          opt.classList.remove('active');
        }
      });
    }

    // Show/hide switcher based on current section
    function updateSwitcherVisibility() {
      const switcher = document.getElementById('lang-switcher');
      if (!switcher) return;

      // Check URL hash
      const hash = window.location.hash.replace('#', '');
      
      // List of non-home section anchors
      const nonHomeAnchors = ['du-an', 'kinh-nghiem', 'lien-he'];
      const isNonHomeHash = hash && nonHomeAnchors.includes(hash);
      
      // Check if we're on the home section by data-anchor
      const homeSection = document.querySelector('.section[data-anchor="home"]');
      const isHomeActive = homeSection && homeSection.classList.contains('active');
      
      // Check if any non-home section is active
      let isNonHomeActive = false;
      nonHomeAnchors.forEach(anchor => {
        const section = document.querySelector(`.section[data-anchor="${anchor}"]`);
        if (section && section.classList.contains('active')) {
          isNonHomeActive = true;
        }
      });
      
      // Show switcher if:
      // - Hash is empty or 'home' (default/initial state)
      // - Home section is active
      // - No hash and no non-home section is active (default to home)
      // Hide if we're definitely on a non-home section
      const shouldShow = (!hash || hash === 'home' || isHomeActive) && !isNonHomeActive && !isNonHomeHash;
      
      if (shouldShow) {
        switcher.classList.add('visible');
        switcher.classList.remove('hidden');
      } else {
        switcher.classList.add('hidden');
        switcher.classList.remove('visible');
      }
    }

    // Initialize on load
    function init() {
      setActiveLang(getCurrentLang());
      updateSwitcherVisibility();

      // Use MutationObserver to watch for section changes
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const target = mutation.target;
            if (target.classList.contains('section')) {
              updateSwitcherVisibility();
            }
          }
        });
      });

      // Observe all sections for class changes
      const sections = document.querySelectorAll('.section');
      sections.forEach((section) => {
        observer.observe(section, {
          attributes: true,
          attributeFilter: ['class']
        });
      });

      // Also listen for hash changes
      window.addEventListener('hashchange', updateSwitcherVisibility);

      // Fallback: check periodically (in case MutationObserver doesn't catch everything)
      const visibilityInterval = setInterval(updateSwitcherVisibility, 200);

      // Clean up interval on page unload to prevent memory leaks
      window.addEventListener('beforeunload', () => {
        clearInterval(visibilityInterval);
      });

      // Clean up on pagehide (more reliable than beforeunload in some browsers)
      window.addEventListener('pagehide', () => {
        clearInterval(visibilityInterval);
      });

      // Handle click using event delegation
      setupClickHandler();
    }

    function setupClickHandler() {
      const switcher = document.getElementById('lang-switcher');
      if (!switcher) {
        // Retry if not ready yet
        setTimeout(setupClickHandler, 100);
        return;
      }
      
      // Use event delegation - attach to button, handle clicks on children
      switcher.addEventListener('click', function(e) {
        // Find the clicked lang-option
        let target = e.target;
        
        // Traverse up to find lang-option
        while (target && target !== switcher) {
          if (target.classList && target.classList.contains('lang-option')) {
            const lang = target.dataset.lang;
            if (lang === 'vi' || lang === 'en') {
              e.preventDefault();
              e.stopPropagation();
              
              console.log('Language switcher clicked, switching to:', lang);
              
              // Save to localStorage
              localStorage.setItem('lang', lang);
              
              // Dispatch event with bubbles and cancelable
              const event = new CustomEvent('langchange', { 
                detail: { lang: lang },
                bubbles: true,
                cancelable: true
              });
              
              const dispatched = window.dispatchEvent(event);
              console.log('Event dispatched:', dispatched, 'Event detail:', event.detail);
              
              return;
            }
          }
          target = target.parentElement;
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

<style>
  .lang-switcher {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(14, 165, 233, 0.2);
    border-radius: 999px;
    font-family: 'Be Vietnam Pro', system-ui, -apple-system, sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    /* Default to visible - will be hidden by JS if needed */
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .lang-switcher.hidden {
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
  }

  .lang-switcher.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .lang-switcher:hover {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(14, 165, 233, 0.4);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }

  .lang-switcher:active {
    transform: translateY(0);
  }

  .lang-option {
    padding: 0.25rem 0.5rem;
    color: var(--text, #0a0a0a);
    transition: all 0.2s ease;
    user-select: none;
    border-radius: 6px;
    display: flex;
    align-items: center;
    cursor: pointer;
    pointer-events: auto;
  }

  .lang-option * {
    pointer-events: none;
  }

  .lang-option .text {
    font-size: 0.9rem;
  }

  .lang-option.active {
    color: var(--text, #0a0a0a);
    background: rgba(14, 165, 233, 0.15);
    font-weight: 700;
  }

  .lang-option.active .text {
    color: #0a0a0a;
  }

  .lang-option:hover:not(.active) {
    color: var(--text, #0a0a0a);
    background: rgba(14, 165, 233, 0.05);
  }

  .lang-separator {
    color: var(--text, #0a0a0a);
    user-select: none;
    pointer-events: none;
  }

  .globe-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.5rem;
    color: var(--muted, #475569);
    flex-shrink: 0;
  }

  .globe-icon .globe-svg {
    width: 16px;
    height: 16px;
    display: block;
    fill: currentColor;
  }

  /* Mobile responsive */
  @media (max-width: 640px) {
    .lang-switcher {
      top: 15px;
      right: 15px;
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      gap: 0.4rem;
    }

    .lang-option {
      padding: 0.2rem 0.4rem;
    }

    .lang-option .text {
      font-size: 0.8rem;
    }

    .globe-icon .globe-svg {
      width: 14px;
      height: 14px;
    }
  }

  /* Ensure it doesn't conflict with navigation dots */
  @media (min-width: 641px) {
    .lang-switcher {
      top: 20px;
      right: 60px; /* Leave space for navigation dots */
    }
  }
</style>
