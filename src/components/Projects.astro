---
import { getTranslations, getLang } from '@i18n/utils';

const lang = getLang(Astro.url);
const t = await getTranslations(lang);
const projects = t.projects.items;
const labels = t.projects.labels;

// Animation delay configuration
const ANIMATION_BASE_DELAY = 0; // Base delay in milliseconds
const ANIMATION_STAGGER_DELAY = 200; // Delay increment between each card

// Helper function to truncate text
function truncate(text: string, maxLength: number): string {
  if (!text || text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + '...';
}

// Helper function to escape URL for CSS
function escapeCssUrl(url: string): string {
  if (!url) return '';
  // Escape single quotes, double quotes, and backslashes for CSS url()
  return url.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
}
---

<section id="du-an" class="projects-section" data-slide-in="right">
  <header>
    <h2 class="fade-in-item" data-i18n="projects.title" data-fade-delay="0">{t.projects.title}</h2>
  </header>
  <div class="projects-grid">
    {projects.map((project: any, index: number) => (
      <article 
        class="project-card fade-in-item" 
        data-project-index={index}
        data-fade-delay={ANIMATION_BASE_DELAY + index * ANIMATION_STAGGER_DELAY}
        data-i18n-name={`projects.items.${index}.name`}
        data-i18n-description={`projects.items.${index}.description`}
        data-i18n-period={`projects.items.${index}.period`}
      >
        {project.gallery && project.gallery.length > 0 && (
          <div 
            class="card-background" 
            style={`background-image: url('${escapeCssUrl(project.gallery[0])}')`}
          ></div>
        )}
        <div class="card-content">
          <h3 data-i18n={`projects.items.${index}.name`}>{project.name}</h3>
          <p class="description" data-i18n={`projects.items.${index}.description`}>
            {truncate(project.description, 120)}
          </p>
          <div class="tools">
            {project.tools && project.tools.map((tool: string) => (
              <span class="tool-tag">{tool}</span>
            ))}
          </div>
        </div>
      </article>
    ))}
  </div>
</section>

<!-- Modal for project details -->
<div id="project-modal" class="project-modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <button class="modal-close" aria-label="Close modal">&times;</button>
    <div id="modal-body"></div>
  </div>
</div>

<script is:inline define:vars={{ projectsData: JSON.stringify(projects), labelsData: JSON.stringify(labels) }}>
  // Store projects data for modal (parse JSON strings)
  try {
    window.projectsData = typeof projectsData === 'string' ? JSON.parse(projectsData) : projectsData;
    window.labelsData = typeof labelsData === 'string' ? JSON.parse(labelsData) : labelsData;
  } catch (e) {
    console.error('Error parsing projects data:', e);
    window.projectsData = [];
    window.labelsData = {};
  }
</script>

<script is:inline>
  // Load GLightbox CSS
  if (!document.querySelector('link[href*="glightbox"]')) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css';
    document.head.appendChild(link);
  }

  // Load GLightbox JS
  if (!document.querySelector('script[src*="glightbox"]')) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js';
    script.onload = function() {
      // @ts-ignore - GLightbox is loaded dynamically
      if (typeof GLightbox !== 'undefined') {
        // @ts-ignore - GLightbox is loaded dynamically
        GLightbox({
          selector: '.glightbox',
          touchNavigation: true,
          loop: true,
          autoplayVideos: true
        });
      }
    };
    document.head.appendChild(script);
  }

  // Modal functionality
  function initModal() {
    const modal = document.getElementById('project-modal');
    const modalBody = document.getElementById('modal-body');
    const closeBtn = modal?.querySelector('.modal-close');
    const backdrop = modal?.querySelector('.modal-backdrop');
    const projectCards = document.querySelectorAll('.project-card');

    if (!modal || !modalBody) return;

    // Helper function to escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Open modal with project details
    function openModal(projectIndex) {
      const projects = window.projectsData || [];
      const labels = window.labelsData || {};
      const project = projects[projectIndex];
      if (!project) return;

      // Get translated labels
      const roleLabel = labels.role || 'Role:';
      const tasksLabel = labels.tasks || 'Tasks:';
      const resultsLabel = labels.results || 'Results:';
      const toolsLabel = labels.tools || 'Technologies:';

      // Escape all user-controlled data
      const escapedName = escapeHtml(project.name || '');
      const escapedPeriod = project.period ? escapeHtml(project.period) : '';
      const escapedDescription = escapeHtml(project.description || '');
      const escapedRole = project.role ? escapeHtml(project.role) : '';
      const escapedImpact = project.impact ? escapeHtml(project.impact) : '';
      const escapedGalleryName = escapeHtml(project.name || '').replace(/\s+/g, '-').toLowerCase();

      // Build modal content with escaped data
      let modalHTML = `
        <div class="modal-header">
          <h3 data-i18n="projects.items.${projectIndex}.name">${escapedName}</h3>
          ${escapedPeriod ? `<p class="period" data-i18n="projects.items.${projectIndex}.period">${escapedPeriod}</p>` : ''}
        </div>
        <div class="modal-body-content">
          <div class="modal-section">
            <p class="description" data-i18n="projects.items.${projectIndex}.description">${escapedDescription}</p>
          </div>
          ${escapedRole ? `
            <div class="modal-section">
              <strong>${escapeHtml(roleLabel)}</strong>
              <span data-i18n="projects.items.${projectIndex}.role">${escapedRole}</span>
            </div>
          ` : ''}
          ${project.tasks && project.tasks.length > 0 ? `
            <div class="modal-section">
              <strong>${escapeHtml(tasksLabel)}</strong>
              <ul class="task-list">
                ${project.tasks.map((task, idx) => `
                  <li data-i18n="projects.items.${projectIndex}.tasks.${idx}">${escapeHtml(task)}</li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
          ${escapedImpact ? `
            <div class="modal-section">
              <strong>${escapeHtml(resultsLabel)}</strong>
              <p class="impact" data-i18n="projects.items.${projectIndex}.impact">${escapedImpact}</p>
            </div>
          ` : ''}
          ${project.tools && project.tools.length > 0 ? `
            <div class="modal-section">
              <strong>${escapeHtml(toolsLabel)}</strong>
              <ul class="tools">
                ${project.tools.map((tool) => `<li>${escapeHtml(tool)}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          ${project.gallery && project.gallery.length > 0 ? `
            <div class="modal-section gallery-section">
              <div class="gallery" role="region" aria-label="Project gallery">
                ${project.gallery.map((image, imgIndex) => {
                  const escapedImage = escapeHtml(image);
                  const escapedAlt = escapeHtml(`${project.name || ''} - ${imgIndex + 1}`);
                  return `
                  <figure>
                    <a href="${escapedImage}" class="glightbox" data-gallery="gallery-${escapedGalleryName}">
                      <img src="${escapedImage}" alt="${escapedAlt}" loading="lazy" />
                    </a>
                  </figure>
                `;
                }).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;

      modalBody.innerHTML = modalHTML;
      modal?.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Reinitialize GLightbox for new gallery
      if (typeof GLightbox !== 'undefined') {
        // @ts-ignore
        GLightbox({
          selector: '.glightbox',
          touchNavigation: true,
          loop: true,
          autoplayVideos: true
        });
      }

      // Update i18n for modal content
      if (window.updateI18n) {
        window.updateI18n();
      }
    }

    // Close modal
    function closeModal() {
      modal?.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Event listeners
    projectCards.forEach((card) => {
      card.addEventListener('click', function() {
        const index = parseInt(card.getAttribute('data-project-index') || '0');
        openModal(index);
      });
    });

    closeBtn?.addEventListener('click', closeModal);
    backdrop?.addEventListener('click', closeModal);

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal?.classList.contains('active')) {
        closeModal();
      }
    });
  }

  // Initialize modal - check if DOM is already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initModal);
  } else {
    // DOM is already loaded, run immediately
    initModal();
  }
</script>

<style>
  .projects-section {
    margin-top: 0 !important;
    width: 100%;
    max-width: 100%;
    margin-left: 0;
    margin-right: 0;
    padding: 2rem 1rem;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: stretch;
    overflow-y: visible;
    min-height: 100vh;
    height: auto;
    visibility: visible !important;
  }

  header {
    margin-bottom: 2rem;
  }

  header h2 {
    margin-top: 0;
    font-size: clamp(2rem, 4vw, 2.8rem);
    position: relative;
  }

  header h2::after {
    content: '';
    display: block;
    width: 56px;
    height: 4px;
    border-radius: 999px;
    background: var(--accent);
    margin-top: 0.5rem;
  }

  .projects-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    width: 100%;
  }

  @media (min-width: 768px) {
    .projects-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 2rem;
    }
  }

  .project-card {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    background: var(--card);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    min-height: 320px;
    display: flex;
    flex-direction: column;
  }

  .project-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
  }

  .project-card:hover .card-background {
    filter: blur(0px) brightness(0.8);
    z-index: 3;
  }

  .project-card:hover .card-content {
    opacity: 0;
    visibility: hidden;
  }

  .card-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    filter: blur(8px) brightness(0.4);
    z-index: 0;
    transition: filter 0.3s ease;
  }

  .card-content {
    position: relative;
    z-index: 1;
    padding: 2rem;
    flex: 1;
    display: flex;
    flex-direction: column;
    background: linear-gradient(to bottom, transparent 0%, rgba(30, 41, 59, 0.7) 50%, rgba(15, 23, 42, 0.95) 100%);
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .card-content h3 {
    margin: 0 0 1rem;
    font-size: clamp(1.25rem, 3vw, 1.5rem);
    color: #ffffff;
    font-weight: 700;
    text-align: center;
  }

  .card-content .description {
    margin: 0 0 1.5rem;
    color: rgba(255, 255, 255, 0.85);
    line-height: 1.6;
    flex: 1;
    font-size: 0.95rem;
    text-align: center;
  }

  .card-content .tools {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: auto;
    justify-content: center;
  }

  .tool-tag {
    display: inline-flex;
    align-items: center;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    background: rgba(30, 41, 59, 0.6);
    color: #ffffff;
    font-size: 0.8rem;
    font-weight: 500;
    border: 1px solid rgba(51, 65, 85, 0.4);
    backdrop-filter: blur(4px);
  }

  /* Modal Styles */
  .project-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    pointer-events: none;
  }

  .project-modal.active {
    display: flex;
    opacity: 1;
    visibility: visible;
    pointer-events: all;
  }

  .modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    position: relative;
    z-index: 1001;
    background: var(--card);
    border-radius: 24px;
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    padding: 2rem;
    margin: 2rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: scale(0.9);
    transition: transform 0.3s ease;
  }

  .project-modal.active .modal-content {
    transform: scale(1);
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
    z-index: 1002;
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .modal-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }

  .modal-header h3 {
    margin: 0 0 0.5rem;
    font-size: clamp(1.5rem, 4vw, 2rem);
    color: var(--text);
  }

  .modal-header .period {
    margin: 0;
    font-size: 0.9rem;
    color: var(--muted);
    font-weight: 500;
  }

  .modal-body-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .modal-section {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .modal-section strong {
    color: var(--text);
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
  }

  .modal-section .description {
    color: var(--muted);
    line-height: 1.7;
    margin: 0;
  }

  .modal-section .task-list {
    list-style: disc;
    padding-left: 1.5rem;
    margin: 0.5rem 0 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .modal-section .task-list li {
    color: var(--muted);
    line-height: 1.6;
  }

  .modal-section .impact {
    color: var(--muted);
    line-height: 1.6;
    margin: 0.5rem 0 0;
  }

  .modal-section .tools {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .modal-section .tools li {
    display: inline-flex;
    align-items: center;
    padding: 0.4rem 0.8rem;
    border-radius: 999px;
    background: rgba(14, 165, 233, 0.12);
    font-size: 0.85rem;
    font-weight: 600;
    color: #075985;
  }

  .gallery-section .gallery {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  .gallery-section .gallery figure {
    margin: 0;
    border-radius: 12px;
    overflow: hidden;
    background: rgba(15, 23, 42, 0.6);
  }

  .gallery-section .gallery a {
    display: block;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .gallery-section .gallery a:hover {
    opacity: 0.9;
  }

  .gallery-section .gallery img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    display: block;
  }

  @media (max-width: 640px) {
    .projects-section {
      padding: 1.5rem 1rem;
    }

    .project-card {
      min-height: 280px;
    }

    .card-content {
      padding: 1.5rem;
    }

    .modal-content {
      width: 95%;
      padding: 1.5rem;
      margin: 1rem;
    }

    .gallery-section .gallery {
      grid-template-columns: 1fr;
    }
  }
</style>
