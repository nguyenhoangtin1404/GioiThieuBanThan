---
import { getTranslations, getLang } from '@i18n/utils';
import ProjectDetail from '@components/ProjectDetail.astro';

const lang = getLang(Astro.url);
const t = await getTranslations(lang);
const projects = t.projects.items;
const labels = t.projects.labels;
const actions = t.projects.actions || {};
const sections = t.projects.sections || {};
const galleryAlt = t.projects.galleryAlt || '';

// Load both languages for client-side switching
const tVi = await getTranslations('vi');
const tEn = await getTranslations('en');
const projectsVi = tVi.projects.items;
const projectsEn = tEn.projects.items;
const labelsVi = tVi.projects.labels;
const labelsEn = tEn.projects.labels;
const actionsVi = tVi.projects.actions || {};
const actionsEn = tEn.projects.actions || {};
const sectionsVi = tVi.projects.sections || {};
const sectionsEn = tEn.projects.sections || {};
const galleryAltVi = tVi.projects.galleryAlt || '';
const galleryAltEn = tEn.projects.galleryAlt || '';

// Animation delay configuration
const ANIMATION_BASE_DELAY = 0; // Base delay in milliseconds
const ANIMATION_STAGGER_DELAY = 200; // Delay increment between each card

// Helper function to truncate text
function truncate(text: string, maxLength: number): string {
  if (!text || text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + '...';
}

// Helper function to escape URL for CSS
function escapeCssUrl(url: string): string {
  if (!url) return '';
  // Escape single quotes, double quotes, and backslashes for CSS url()
  return url.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
}

// Helper function to transform image URL based on language
function getImageUrlForLang(imageUrl: string, lang: string): string {
  if (!imageUrl || typeof imageUrl !== 'string') return imageUrl;
  if (lang === 'vi') return imageUrl;
  
  // English: add _en before extension
  const lastDot = imageUrl.lastIndexOf('.');
  if (lastDot === -1) return imageUrl + '_en';
  
  const path = imageUrl.substring(0, lastDot);
  const ext = imageUrl.substring(lastDot);
  return `${path}_en${ext}`;
}
---

<section id="du-an" class="projects-section" data-slide-in="right">
  <header>
    <h2 class="fade-in-item" data-i18n="projects.title" data-fade-delay="0">{t.projects.title}</h2>
  </header>
  <div class="projects-grid">
    {projects.map((project: any, index: number) => (
      <article 
        class="project-card fade-in-item" 
        data-project-index={index}
        data-project-id={project.id}
        data-fade-delay={ANIMATION_BASE_DELAY + index * ANIMATION_STAGGER_DELAY}
        data-i18n-name={`projects.items.${index}.name`}
        data-i18n-description={`projects.items.${index}.description`}
        data-i18n-period={`projects.items.${index}.period`}
      >
        <div
          class="card-background"
          data-project-id={project.id}
          style={project.gallery && project.gallery.length > 0
            ? `background-image: url('${escapeCssUrl(getImageUrlForLang(project.gallery[0], lang))}')`
            : ''}
        ></div>
        <div class="card-content">
          <h3 data-i18n={`projects.items.${index}.name`}>{project.name}</h3>
          {project.problem ? (
            <div class="project-metrics">
              <div class="metric-row">
                <span class="metric-label" data-i18n="projects.labels.problem">{labels.problem}</span>
                <span class="metric-value" data-i18n={`projects.items.${index}.problem`}>{project.problem}</span>
              </div>
              <div class="metric-row">
                <span class="metric-label" data-i18n="projects.labels.myRole">{labels.myRole}</span>
                <span class="metric-value" data-i18n={`projects.items.${index}.myRole`}>{project.myRole}</span>
              </div>
              <div class="metric-row">
                <span class="metric-label" data-i18n="projects.labels.impact">{labels.impact}</span>
                <span class="metric-value" data-i18n={`projects.items.${index}.impact`}>{project.impact}</span>
              </div>
            </div>
          ) : (
            <p class="description" data-i18n={`projects.items.${index}.description`}>
              {truncate(project.description, 120)}
            </p>
          )}
          <div class="tools">
            {project.tools && project.tools.map((tool: string) => (
              <span class="tool-tag">{tool}</span>
            ))}
          </div>
        </div>
      </article>
    ))}
  </div>
</section>

<!-- Modal for project details -->
<div id="project-modal" class="project-modal" aria-hidden="true">
  <div class="modal-backdrop" data-modal-close></div>
  <div class="modal-sheet" role="dialog" aria-modal="true" aria-labelledby="project-modal-title" tabindex="-1">
    <div class="modal-handle" aria-hidden="true"></div>
    <button class="modal-close" type="button" aria-label="Close modal" data-modal-close>&times;</button>
    <ProjectDetail
      variant="modal"
      labels={labels}
      actions={actions}
      sections={sections}
      galleryAlt={galleryAlt}
    />
  </div>
</div>

<script is:inline define:vars={{ 
  projectsData: JSON.stringify(projects), 
  labelsData: JSON.stringify(labels), 
  actionsData: JSON.stringify(actions), 
  sectionsData: JSON.stringify(sections), 
  galleryAltData: JSON.stringify(galleryAlt),
  projectsDataVi: JSON.stringify(projectsVi),
  projectsDataEn: JSON.stringify(projectsEn),
  labelsDataVi: JSON.stringify(labelsVi),
  labelsDataEn: JSON.stringify(labelsEn),
  actionsDataVi: JSON.stringify(actionsVi),
  actionsDataEn: JSON.stringify(actionsEn),
  sectionsDataVi: JSON.stringify(sectionsVi),
  sectionsDataEn: JSON.stringify(sectionsEn),
  galleryAltDataVi: JSON.stringify(galleryAltVi),
  galleryAltDataEn: JSON.stringify(galleryAltEn)
}}>
  // Store projects data for modal (parse JSON strings)
  try {
    // Store current language data
    window.projectsData = typeof projectsData === 'string' ? JSON.parse(projectsData) : projectsData;
    window.labelsData = typeof labelsData === 'string' ? JSON.parse(labelsData) : labelsData;
    window.projectActionsData = typeof actionsData === 'string' ? JSON.parse(actionsData) : actionsData;
    window.projectSectionsData = typeof sectionsData === 'string' ? JSON.parse(sectionsData) : sectionsData;
    window.projectGalleryAlt = typeof galleryAltData === 'string' ? JSON.parse(galleryAltData) : galleryAltData;
    
    // Store both language versions for switching
    window.projectsDataVi = typeof projectsDataVi === 'string' ? JSON.parse(projectsDataVi) : projectsDataVi;
    window.projectsDataEn = typeof projectsDataEn === 'string' ? JSON.parse(projectsDataEn) : projectsDataEn;
    window.labelsDataVi = typeof labelsDataVi === 'string' ? JSON.parse(labelsDataVi) : labelsDataVi;
    window.labelsDataEn = typeof labelsDataEn === 'string' ? JSON.parse(labelsDataEn) : labelsDataEn;
    window.projectActionsDataVi = typeof actionsDataVi === 'string' ? JSON.parse(actionsDataVi) : actionsDataVi;
    window.projectActionsDataEn = typeof actionsDataEn === 'string' ? JSON.parse(actionsDataEn) : actionsDataEn;
    window.projectSectionsDataVi = typeof sectionsDataVi === 'string' ? JSON.parse(sectionsDataVi) : sectionsDataVi;
    window.projectSectionsDataEn = typeof sectionsDataEn === 'string' ? JSON.parse(sectionsDataEn) : sectionsDataEn;
    window.projectGalleryAltVi = typeof galleryAltDataVi === 'string' ? JSON.parse(galleryAltDataVi) : galleryAltDataVi;
    window.projectGalleryAltEn = typeof galleryAltDataEn === 'string' ? JSON.parse(galleryAltDataEn) : galleryAltDataEn;
  } catch (e) {
    console.error('Error parsing projects data:', e);
    window.projectsData = [];
    window.labelsData = {};
    window.projectActionsData = {};
    window.projectSectionsData = {};
    window.projectGalleryAlt = '';
  }
</script>

<script is:inline>
  // Load GLightbox CSS
  if (!document.querySelector('link[href*="glightbox"]')) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css';
    document.head.appendChild(link);
  }

  // Load GLightbox JS
  if (!document.querySelector('script[src*="glightbox"]')) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js';
    script.onload = function() {
      // @ts-ignore - GLightbox is loaded dynamically
      if (typeof GLightbox !== 'undefined') {
        // @ts-ignore - GLightbox is loaded dynamically
        GLightbox({
          selector: '.glightbox',
          touchNavigation: true,
          loop: true,
          autoplayVideos: true
        });
      }
    };
    document.head.appendChild(script);
  }

  // Modal functionality
  function initModal() {
    const modal = document.getElementById('project-modal');
    if (!modal) return;

    // IMPORTANT: Move modal to <body> to escape fullpage section stacking contexts (transform)
    // Otherwise fixed elements like .sidebar-nav (outside #fullpage) can appear above the modal.
    if (modal.parentElement !== document.body) {
      document.body.appendChild(modal);
    }

    const sheet = modal.querySelector('.modal-sheet');
    const closeButtons = modal.querySelectorAll('[data-modal-close], [data-pd-close]');
    const projectCards = document.querySelectorAll('.project-card');

    if (!sheet) return;

    // Cache modal fields from ProjectDetail (variant="modal")
    const titleEl = modal.querySelector('[data-pd-title]');
    const metaEl = modal.querySelector('[data-pd-meta]');
    const impactSection = modal.querySelector('[data-pd-impact]');
    const impactTitleEl = modal.querySelector('.pd-impact-title');
    const impactBody = modal.querySelector('[data-pd-impact-body]');
    const overviewSection = modal.querySelector('[data-pd-overview]');
    const overviewTitleEl = modal.querySelector('[data-pd-overview] .pd-section-title');
    const descEl = modal.querySelector('[data-pd-description]');
    const tasksSection = modal.querySelector('[data-pd-tasks]');
    const tasksList = modal.querySelector('[data-pd-tasks-list]');
    const toolsSection = modal.querySelector('[data-pd-tools]');
    const toolsTitleEl = modal.querySelector('[data-pd-tools] .pd-section-title');
    const toolsChips = modal.querySelector('[data-pd-tools-chips]');
    const gallerySection = modal.querySelector('[data-pd-gallery]');
    const galleryTitleEl = modal.querySelector('[data-pd-gallery] .pd-section-title');
    const galleryGrid = modal.querySelector('[data-pd-gallery-grid]');
    const galleryPrevBtn = modal.querySelector('[data-pd-carousel-prev]');
    const galleryNextBtn = modal.querySelector('[data-pd-carousel-next]');
    const subProjectsSection = modal.querySelector('[data-pd-subprojects]');
    const subProjectsTabs = modal.querySelector('[data-pd-subprojects-tabs]');
    const subProjectsPanel = modal.querySelector('[data-pd-subprojects-panel]');
    const viewDetailLink = modal.querySelector('[data-pd-view-detail]');

    let lastFocusedEl = null;
    let currentProjectId = null; // Track currently open project for language switching

    function getCurrentLang() {
      try {
        if (typeof window.getCurrentLang === 'function') return window.getCurrentLang();
      } catch {}
      const urlParams = new URLSearchParams(window.location.search);
      const langParam = urlParams.get('lang');
      if (langParam === 'vi' || langParam === 'en') return langParam;
      const stored = localStorage.getItem('lang');
      if (stored === 'vi' || stored === 'en') return stored;
      return 'vi';
    }

    // Helper function to transform image URL based on language
    function getImageUrlForLang(imageUrl, lang) {
      if (!imageUrl || typeof imageUrl !== 'string') return imageUrl;
      if (lang === 'vi') return imageUrl;
      
      // English: add _en before extension
      const lastDot = imageUrl.lastIndexOf('.');
      if (lastDot === -1) return imageUrl + '_en';
      
      const path = imageUrl.substring(0, lastDot);
      const ext = imageUrl.substring(lastDot);
      return `${path}_en${ext}`;
    }

    // Helper function to transform entire gallery array
    function getGalleryForLang(gallery, lang) {
      if (!Array.isArray(gallery)) return [];
      return gallery.map(url => getImageUrlForLang(url, lang));
    }

    function buildDetailUrl(projectId) {
      const lang = getCurrentLang();
      return `/projects/${encodeURIComponent(projectId)}?lang=${encodeURIComponent(lang)}`;
    }

    function setHidden(el, hidden) {
      if (!el) return;
      el.hidden = !!hidden;
    }

    function clearChildren(el) {
      if (!el) return;
      while (el.firstChild) el.removeChild(el.firstChild);
    }

    function renderSubProjects(subProjects) {
      if (!subProjectsSection || !subProjectsTabs || !subProjectsPanel) return;
      const labels = window.labelsData || {};
      const resultsLabel = labels.results || 'Results:';
      const toolsLabel = labels.tools || 'Technologies:';

      setHidden(subProjectsSection, false);
      clearChildren(subProjectsTabs);
      clearChildren(subProjectsPanel);

      function renderPanel(idx) {
        clearChildren(subProjectsPanel);
        const sp = subProjects[idx] || {};

        if (sp.name) {
          const title = document.createElement('h3');
          title.className = 'pd-subproject-title';
          title.textContent = sp.name;
          subProjectsPanel.appendChild(title);
        }

        if (sp.summary) {
          const summaryWrap = document.createElement('div');
          const summaryLabel = document.createElement('div');
          summaryLabel.className = 'pd-subproject-label';
          summaryLabel.textContent = resultsLabel;

          const summary = document.createElement('p');
          summary.className = 'pd-subproject-summary';
          summary.textContent = sp.summary;

          summaryWrap.appendChild(summaryLabel);
          summaryWrap.appendChild(summary);
          subProjectsPanel.appendChild(summaryWrap);
        }

        if (Array.isArray(sp.tools) && sp.tools.length > 0) {
          const toolsWrap = document.createElement('div');
          const toolsLabelEl = document.createElement('div');
          toolsLabelEl.className = 'pd-subproject-label';
          toolsLabelEl.textContent = toolsLabel;

          const toolsList = document.createElement('div');
          toolsList.className = 'pd-subproject-tools';
          sp.tools.forEach((tool) => {
            const chip = document.createElement('span');
            chip.className = 'pd-chip';
            chip.textContent = tool;
            toolsList.appendChild(chip);
          });

          toolsWrap.appendChild(toolsLabelEl);
          toolsWrap.appendChild(toolsList);
          subProjectsPanel.appendChild(toolsWrap);
        }
      }

      function setActive(idx) {
        const tabs = subProjectsTabs.querySelectorAll('[role="tab"]');
        tabs.forEach((tab, tabIdx) => {
          const isActive = tabIdx === idx;
          tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
          if (isActive) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });
        renderPanel(idx);
      }

      subProjects.forEach((sp, idx) => {
        const tab = document.createElement('button');
        tab.type = 'button';
        tab.className = 'pd-subprojects-tab';
        tab.setAttribute('role', 'tab');
        tab.setAttribute('aria-selected', idx === 0 ? 'true' : 'false');
        if (idx === 0) tab.classList.add('active');
        tab.textContent = sp.name || `Project ${idx + 1}`;
        tab.addEventListener('click', () => setActive(idx));
        subProjectsTabs.appendChild(tab);
      });

      setActive(0);
    }

    function getProjectById(projectId) {
      const projects = window.projectsData || [];
      return projects.find(p => p && p.id === projectId) || null;
    }

    function renderProjectToModal(project) {
      if (!project) return;
      const subProjects = Array.isArray(project.subProjects) ? project.subProjects : [];
      const hasSubProjects = subProjects.length > 0;
      const labels = window.labelsData || {};
      const sections = window.projectSectionsData || {};

      // Update labels and section titles
      if (impactTitleEl) impactTitleEl.textContent = labels.results || 'Results:';
      if (overviewTitleEl) overviewTitleEl.textContent = sections.overview || 'Overview';
      if (toolsTitleEl) toolsTitleEl.textContent = labels.tools || 'Technologies:';
      if (galleryTitleEl) galleryTitleEl.textContent = sections.gallery || 'Gallery';

      // Title
      if (titleEl) titleEl.textContent = project.name || '';

      // Meta (Period/Role) - Show in modal now
      if (metaEl) {
        metaEl.hidden = false;
        const periodEl = modal.querySelector('[data-pd-period]');
        const roleEl = modal.querySelector('[data-pd-role]');
        
        if (periodEl) {
          periodEl.textContent = project.period || '';
          periodEl.hidden = !project.period;
        }
        if (roleEl) {
          roleEl.textContent = project.role || '';
          roleEl.hidden = !project.role;
        }
      }

      if (hasSubProjects) {
        setHidden(impactSection, true);
        setHidden(overviewSection, true);
        setHidden(tasksSection, true);
        setHidden(toolsSection, true);
        setHidden(gallerySection, true);
        clearChildren(tasksList);
        clearChildren(toolsChips);
        clearChildren(galleryGrid);
        renderSubProjects(subProjects);
      } else {
        setHidden(subProjectsSection, true);
        clearChildren(subProjectsTabs);
        clearChildren(subProjectsPanel);

        // Impact
        const hasImpact = !!project.impact;
        setHidden(impactSection, !hasImpact);
        if (impactBody) impactBody.textContent = project.impact || '';

        // Overview
        const hasDesc = !!project.description;
        setHidden(overviewSection, !hasDesc);
        if (descEl) descEl.textContent = project.description || '';

        // Tasks - Show in modal now
        const hasTasks = Array.isArray(project.tasks) && project.tasks.length > 0;
        setHidden(tasksSection, !hasTasks);
        clearChildren(tasksList);
        if (hasTasks && tasksList) {
           project.tasks.forEach(task => {
             const li = document.createElement('li');
             li.textContent = task;
             tasksList.appendChild(li);
           });
        }

        // Tools
        const hasTools = Array.isArray(project.tools) && project.tools.length > 0;
        setHidden(toolsSection, !hasTools);
        clearChildren(toolsChips);
        if (hasTools && toolsChips) {
          project.tools.forEach((tool) => {
            const chip = document.createElement('span');
            chip.className = 'pd-chip';
            chip.textContent = tool;
            toolsChips.appendChild(chip);
          });
        }

        // Gallery - Show in modal now
        const hasGallery = Array.isArray(project.gallery) && project.gallery.length > 0;
        setHidden(gallerySection, !hasGallery);
        clearChildren(galleryGrid);
        if (hasGallery && galleryGrid) {
          const galleryAlt = window.projectGalleryAlt || 'Image slide for';
          const currentLang = getCurrentLang();
          const transformedGallery = getGalleryForLang(project.gallery, currentLang);
          
          transformedGallery.forEach((src, idx) => {
            const a = document.createElement('a');
            a.className = 'pd-slide glightbox';
            a.href = src;
            a.setAttribute('data-gallery', `gallery-${project.id || 'project'}`);

            const img = document.createElement('img');
            img.src = src;
            img.alt = `${galleryAlt} ${project.name || ''} - ${idx + 1}`;
            img.loading = 'lazy';
            a.appendChild(img);
            galleryGrid.appendChild(a);
          });
        }
      }

      // Reset carousel position to the start
      try {
        if (galleryGrid && typeof galleryGrid.scrollTo === 'function') {
          galleryGrid.scrollTo({ left: 0, behavior: 'auto' });
        }
      } catch {}

      // View detail link - hide if project has subProjects or hasDetail is explicitly false
      if (viewDetailLink) {
        // Hide for "other-projects" or any project with subProjects or hasDetail: false
        const shouldHide = project.id === 'other-projects' || 
                          hasSubProjects || 
                          project.hasDetail === false ||
                          project.hasDetail === 'false';
        
        if (shouldHide) {
          viewDetailLink.hidden = true;
          viewDetailLink.style.display = 'none';
          viewDetailLink.removeAttribute('href');
        } else {
          const canViewDetail = !!(project.id && !hasSubProjects && project.hasDetail !== false);
          if (canViewDetail) {
            viewDetailLink.hidden = false;
            viewDetailLink.style.display = '';
            viewDetailLink.setAttribute('href', buildDetailUrl(project.id));
          } else {
            viewDetailLink.hidden = true;
            viewDetailLink.style.display = 'none';
            viewDetailLink.removeAttribute('href');
          }
        }
      }

      // Reinitialize GLightbox for new gallery
      // @ts-ignore
      if (typeof GLightbox !== 'undefined') {
        // @ts-ignore
        GLightbox({ selector: '.glightbox', touchNavigation: true, loop: true, autoplayVideos: true });
      }
    }

    // Carousel controls (desktop): jump exactly 1 slide per click
    function jumpSlide(direction) {
      if (!galleryGrid) return;
      const page = galleryGrid.clientWidth || 1;
      const current = Math.round(galleryGrid.scrollLeft / page);
      const slides = galleryGrid.querySelectorAll('.pd-slide').length;
      const nextIndex = Math.max(0, Math.min(slides - 1, current + direction));
      galleryGrid.scrollTo({ left: nextIndex * page, behavior: 'auto' });
    }

    if (galleryPrevBtn) galleryPrevBtn.addEventListener('click', () => jumpSlide(-1));
    if (galleryNextBtn) galleryNextBtn.addEventListener('click', () => jumpSlide(1));

    function getFocusableElements() {
      return Array.from(
        sheet.querySelectorAll(
          'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
        )
      ).filter((el) => !(el.offsetParent === null) && !el.hasAttribute('hidden'));
    }

    function trapFocus(e) {
      if (!modal.classList.contains('active')) return;
      if (e.key === 'Escape') {
        e.preventDefault();
        closeModal();
        return;
      }
      if (e.key !== 'Tab') return;

      const focusables = getFocusableElements();
      if (focusables.length === 0) return;

      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      const active = document.activeElement;

      if (e.shiftKey) {
        if (active === first || !sheet.contains(active)) {
          e.preventDefault();
          last.focus();
        }
      } else {
        if (active === last) {
          e.preventDefault();
          first.focus();
        }
      }
    }

    // Open modal with project details
    function openModal(projectId) {
      if (!projectId) return;

      // Handle history state
      // Only push state if we are not currently on this project URL
      // Check current URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      if (!urlParams.has('project') || urlParams.get('project') !== projectId) {
         const newUrl = new URL(window.location.href);
         newUrl.searchParams.set('project', projectId);
         window.history.pushState({ projectId: projectId }, '', newUrl.toString());
      } else {
         // Replace state just to ensure we have the state object
         window.history.replaceState({ projectId: projectId }, '', window.location.href);
      }

      const project = getProjectById(projectId);
      if (!project) return;

      currentProjectId = projectId; // Track current project
      lastFocusedEl = document.activeElement;
      renderProjectToModal(project);

      // Desktop fullpage: disable wheel/trackpad section switching while modal is open
      try {
        if (window.vanillaFullpage && typeof window.vanillaFullpage.setWheelEnabled === 'function') {
          window.vanillaFullpage.setWheelEnabled(false);
          window.vanillaFullpage.setAllowScrolling(false); // Also disable scrolling
        }
      } catch (e) {
        // ignore
      }

      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';

      // Focus the dialog container for accessibility
      setTimeout(() => sheet.focus(), 0);
      document.addEventListener('keydown', trapFocus);
    }

    // Close modal
    function closeModal(skipHistoryBack = false) {
      // If we need to go back in history (e.g. user clicked X button), do it
      if (!skipHistoryBack && currentProjectId) {
         // Check if current history state matches current project
         if (window.history.state && window.history.state.projectId === currentProjectId) {
             window.history.back();
             return; // Let popstate handler call closeModal again with skipHistoryBack=true
         }
         // Fallback: if no state but we want to clear URL param
         const urlParams = new URLSearchParams(window.location.search);
         if (urlParams.has('project')) {
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.delete('project');
            window.history.replaceState(null, '', newUrl.toString());
         }
      }

      currentProjectId = null; // Clear current project
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      document.removeEventListener('keydown', trapFocus);

      // Desktop fullpage: re-enable wheel/trackpad section switching
      try {
        if (window.vanillaFullpage && typeof window.vanillaFullpage.setWheelEnabled === 'function') {
          window.vanillaFullpage.setWheelEnabled(true);
          window.vanillaFullpage.setAllowScrolling(true);
        }
      } catch (e) {
        // ignore
      }

      if (lastFocusedEl && typeof lastFocusedEl.focus === 'function') {
        setTimeout(() => lastFocusedEl.focus(), 0);
      }
    }

    // Handle back button (popstate)
    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.projectId) {
            // Forward/Back to a project
            // We need to confirm if we are already open on this project to avoid re-rendering loop?
            // But openModal checks getProjectById which is cheap.
            openModal(event.state.projectId); 
            // openModal pushed state, but here we are IN a popstate event, so we shouldn't push again.
            // Wait, openModal logic above unconditionally pushes state!
            // I need to refactor openModal to accept a flag or check history closer.
            // REFACTORING openModal to not push state if already there is simpler.
            // See updated openModal logic above checking URL params.
        } else {
            // Back to root (no project)
            if (modal.classList.contains('active')) {
                closeModal(true); // true = skip history.back()
            }
        }
    });

    // Check URL on load to open modal if needed
    setTimeout(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('project');
        if (projectId) {
            const project = getProjectById(projectId);
            if (project) {
                openModal(projectId);
            }
        }
    }, 500); // Delay to allow data loading

    // Event listeners
    projectCards.forEach((card) => {
      card.addEventListener('click', function() {
        const id = card.getAttribute('data-project-id') || '';
        if (id) openModal(id);
      });
    });

    closeButtons.forEach((btn) => btn.addEventListener('click', closeModal));

    // Click backdrop closes
    modal.addEventListener('click', (e) => {
      const target = e.target;
      if (target && target.hasAttribute && target.hasAttribute('data-modal-close')) {
        closeModal();
      }
    });

    // Update projects data and re-render modal when language changes
    function updateProjectsDataForLang(lang) {
      if (lang === 'vi') {
        window.projectsData = window.projectsDataVi || [];
        window.labelsData = window.labelsDataVi || {};
        window.projectActionsData = window.projectActionsDataVi || {};
        window.projectSectionsData = window.projectSectionsDataVi || {};
        window.projectGalleryAlt = window.projectGalleryAltVi || '';
      } else if (lang === 'en') {
        window.projectsData = window.projectsDataEn || [];
        window.labelsData = window.labelsDataEn || {};
        window.projectActionsData = window.projectActionsDataEn || {};
        window.projectSectionsData = window.projectSectionsDataEn || {};
        window.projectGalleryAlt = window.projectGalleryAltEn || '';
      }

      // Update action buttons text
      if (viewDetailLink && window.projectActionsData?.viewDetail) {
        viewDetailLink.textContent = window.projectActionsData.viewDetail;
      }
      const closeBtn = modal.querySelector('[data-pd-close]');
      if (closeBtn && window.projectActionsData?.close) {
        closeBtn.textContent = window.projectActionsData.close;
      }

      // Update background images of project cards
      const projectCards = document.querySelectorAll('.project-card');
      projectCards.forEach((card) => {
        const projectId = card.getAttribute('data-project-id');
        if (!projectId) return;
        
        const project = getProjectById(projectId);
        if (!project || !project.gallery || project.gallery.length === 0) return;
        
        const backgroundEl = card.querySelector('.card-background');
        if (backgroundEl) {
          const originalUrl = project.gallery[0];
          const transformedUrl = getImageUrlForLang(originalUrl, lang);
          // Escape URL properly for CSS background-image
          const escapedUrl = transformedUrl.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
          backgroundEl.style.backgroundImage = `url('${escapedUrl}')`;
          // Force reflow to ensure browser applies the change
          backgroundEl.style.backgroundImage = backgroundEl.style.backgroundImage;
        }
      });

      // If modal is open, re-render it with new language data
      if (modal.classList.contains('active') && currentProjectId) {
        const project = getProjectById(currentProjectId);
        if (project) {
          renderProjectToModal(project);
        }
      }
    }

    // Listen for language change events (register early to catch BaseLayout's initial update)
    const langChangeHandler = (e) => {
      const newLang = e.detail?.lang;
      if (newLang === 'vi' || newLang === 'en') {
        updateProjectsDataForLang(newLang);
      }
    };
    window.addEventListener('langchange', langChangeHandler);

    // Update images on initial page load to match current language
    // This handles the case where localStorage has 'en' but server rendered with 'vi' (no URL param)
    function updateImagesOnLoad() {
      const currentLang = getCurrentLang();
      
      // Always update images based on current language to ensure consistency
      if (currentLang === 'vi' || currentLang === 'en') {
        updateProjectsDataForLang(currentLang);
      }
    }

    // Run after modal initialization and BaseLayout language update
    // Use multiple triggers to ensure it runs:
    // 1. After a delay (for BaseLayout to finish)
    // 2. On DOMContentLoaded (if page still loading)
    // 3. On langchange event (from BaseLayout) - already handled above
    function scheduleImageUpdate() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(updateImagesOnLoad, 200);
        });
      } else {
        // DOM already loaded, run after BaseLayout has a chance to update
        setTimeout(updateImagesOnLoad, 400);
        // Also run again after a longer delay as fallback
        setTimeout(updateImagesOnLoad, 800);
      }
    }

    scheduleImageUpdate();
  }

  // Initialize modal - check if DOM is already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initModal);
  } else {
    // DOM is already loaded, run immediately
    initModal();
  }
</script>

<style>
  .projects-section {
    margin-top: 0 !important;
    width: 100%;
    max-width: 100%;
    margin-left: 0;
    margin-right: 0;
    padding: 2rem 1rem;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: stretch;
    overflow-y: visible;
    min-height: 100vh;
    height: auto;
    visibility: visible !important;
  }

  header {
    margin-bottom: 2rem;
  }

  header h2 {
    margin-top: 0;
    font-size: clamp(2rem, 4vw, 2.8rem);
    position: relative;
  }

  header h2::after {
    content: '';
    display: block;
    width: 56px;
    height: 4px;
    border-radius: 999px;
    background: var(--accent);
    margin-top: 0.5rem;
  }

  .projects-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    width: 100%;
  }

  @media (min-width: 768px) {
    .projects-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 2rem;
    }
  }

  .project-card {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    background: var(--card);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    min-height: 320px;
    display: flex;
    flex-direction: column;
  }

  .project-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
  }

  .project-card:hover .card-background {
    filter: blur(0px) brightness(0.8);
    z-index: 3;
  }

  .project-card:hover .card-content {
    opacity: 0;
    visibility: hidden;
  }

  .card-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    filter: blur(8px) brightness(0.4);
    z-index: 0;
    transition: filter 0.3s ease;
  }

  .card-content {
    position: relative;
    z-index: 1;
    padding: 2rem;
    flex: 1;
    display: flex;
    flex-direction: column;
    background: linear-gradient(to bottom, transparent 0%, rgba(30, 41, 59, 0.7) 50%, rgba(15, 23, 42, 0.95) 100%);
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .card-content h3 {
    margin: 0 0 1rem;
    font-size: clamp(1.25rem, 3vw, 1.5rem);
    color: #ffffff;
    font-weight: 700;
    text-align: center;
  }

  .card-content .description {
    margin: 0 0 1.5rem;
    color: rgba(255, 255, 255, 0.85);
    line-height: 1.6;
    flex: 1;
    font-size: 0.95rem;
    text-align: center;
  }

  .card-content .tools {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: auto;
    justify-content: center;
  }

  .tool-tag {
    display: inline-flex;
    align-items: center;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    background: rgba(30, 41, 59, 0.6);
    color: #ffffff;
    font-size: 0.8rem;
    font-weight: 500;
    border: 1px solid rgba(51, 65, 85, 0.4);
    backdrop-filter: blur(4px);
  }

  /* Modal Styles - Full Screen */
  .project-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* Must be above BaseLayout sidebar-nav (z-index: 10000) */
    z-index: 20000;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.3s ease;
    pointer-events: none;
  }

  .project-modal.active {
    opacity: 1;
    visibility: visible;
    pointer-events: all;
  }

  .modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(2, 6, 23, 0.95); /* Darker, solid-ish background */
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 1;
  }

  .modal-sheet {
    position: relative;
    z-index: 2;
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    background: transparent;
    overflow-y: auto;
    overflow-x: hidden;
    /* Remove default modal styling */
    border-radius: 0;
    box-shadow: none;
    transform: none !important;
    display: block;
    padding: 0;
    margin: 0;
  }
  
  /* Update project-detail style inside modal to be full screen container */
  .project-modal .project-detail {
    min-height: 100%;
    border-radius: 0;
    border: none;
    box-shadow: none;
    padding: 4rem clamp(1rem, 5vw, 4rem) 4rem;
    max-width: 1100px;
    margin: 0 auto;
    background: transparent; 
  }

  .modal-close {
    position: fixed;
    top: 1.5rem;
    right: 1.5rem;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text);
    font-size: 2rem;
    line-height: 1;
    z-index: 20005; /* Above everything */
    transition: all 0.2s ease;
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
  }

  .modal-handle {
    display: none;
  }

  @media (max-width: 767px) {
    .project-modal .project-detail {
      padding: 5rem 1rem 2rem; /* Add top padding to clear close button */
    }
    
    .modal-close {
      top: 1rem;
      right: 1rem;
      background: rgba(2, 6, 23, 0.3);
    }
  }

  .modal-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }

  .modal-header h3 {
    margin: 0 0 0.5rem;
    font-size: clamp(1.5rem, 4vw, 2rem);
    color: var(--text);
  }

  .modal-header .period {
    margin: 0;
    font-size: 0.9rem;
    color: var(--muted);
    font-weight: 500;
  }

  .modal-body-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .modal-section {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .modal-section strong {
    color: var(--text);
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
  }

  .modal-section .description {
    color: var(--muted);
    line-height: 1.7;
    margin: 0;
  }

  .modal-section .task-list {
    list-style: disc;
    padding-left: 1.5rem;
    margin: 0.5rem 0 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .modal-section .task-list li {
    color: var(--muted);
    line-height: 1.6;
  }

  .modal-section .impact {
    color: var(--muted);
    line-height: 1.6;
    margin: 0.5rem 0 0;
  }

  .modal-section .tools {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .modal-section .tools li {
    display: inline-flex;
    align-items: center;
    padding: 0.4rem 0.8rem;
    border-radius: 999px;
    background: rgba(14, 165, 233, 0.12);
    font-size: 0.85rem;
    font-weight: 600;
    color: #075985;
  }

  .gallery-section .gallery {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  .gallery-section .gallery figure {
    margin: 0;
    border-radius: 12px;
    overflow: hidden;
    background: rgba(15, 23, 42, 0.6);
  }

  .gallery-section .gallery a {
    display: block;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .gallery-section .gallery a:hover {
    opacity: 0.9;
  }

  .gallery-section .gallery img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    display: block;
  }

  @media (max-width: 767px) {
    .project-card {
      background: var(--bg);
      width: 100%;
      max-width: 100%;
      min-width: 0;
      box-sizing: border-box;
    }

    .card-content,
    .card-content h3,
    .card-content .description,
    .card-content .tools,
    .tool-tag {
      min-width: 0;
      max-width: 100%;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
  }

  @media (max-width: 640px) {
    .projects-section {
      padding: 1.5rem 1rem;
    }

    .project-card {
      min-height: 280px;
    }

    .card-content {
      padding: 1.5rem;
    }

    .modal-sheet {
      padding: 1.1rem;
    }

    .gallery-section .gallery {
      grid-template-columns: 1fr;
    }
  }

  /* Project Metrics on Card */
  .project-metrics {
    margin-bottom: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    flex: 1; /* Replace description flex:1 */
  }

  .metric-row {
    display: flex;
    align-items: baseline;
    font-size: 0.9rem;
    line-height: 1.4;
  }

  .metric-label {
    font-weight: 700;
    margin-right: 0.5rem;
    color: var(--accent);
    flex-shrink: 0;
    min-width: 70px;
  }

  .metric-value {
    color: rgba(255, 255, 255, 0.9);
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
</style>
