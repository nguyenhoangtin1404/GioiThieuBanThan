---
import LanguageSwitcher from '@components/LanguageSwitcher.astro';
import { getLang, getTranslations } from '@i18n/utils';

export interface Props {
  title?: string;
  description?: string;
}

const {
  title = 'Nguyễn Hoàng Tín — Full‑Stack Developer',
  description = 'Portfolio & CV online của Nguyễn Hoàng Tín'
} = Astro.props;

// Get initial language (server-side)
const initialLang = getLang(Astro.url);

// Load translations for embedding
const translationsVi = await getTranslations('vi');
const translationsEn = await getTranslations('en');
---

<!doctype html>
<html lang={initialLang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <title>{title}</title>
    <link rel="icon" href="/avatar.png" type="image/png" />
    <link rel="apple-touch-icon" href="/avatar.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap&subset=vietnamese"
      rel="stylesheet"
    />
    <style is:global>
      html { 
        scroll-behavior: smooth;
        overflow: hidden;
      }
      :root {
        color-scheme: light;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        --bg: #f1f1f1;
        --card: #ffffff;
        --accent: #0ea5e9; /* sky-500 */
        --muted: #475569;  /* slate-600 */
        --text: #0a0a0a;   /* near-black */
        --border: transparent;
        --surface-weak: rgba(2, 6, 23, 0.04);
        --surface-softer: rgba(2, 6, 23, 0.03);
        /* new visuals */
        --radius-lg: 24px;
        --radius-md: 16px;
        --shadow-sm: none;
        --shadow-md: none;
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        min-height: 100vh;
        color: var(--text);
        line-height: 1.6;
        overflow: hidden;
        position: relative;
      }

      /* Khi có fullpage, body không có margin/padding và background */
      body:has(#fullpage) {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: transparent !important;
      }

      html:has(#fullpage) {
        background: transparent !important;
      }

      main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem clamp(1rem, 4vw, 3rem) 4rem;
      }

      /* Khi có fullpage, main không cần padding và max-width */
      body:has(#fullpage) main {
        max-width: 100%;
        padding: 0 !important;
        margin: 0 !important;
        height: 100vh;
        overflow: hidden;
        position: relative;
        top: 0;
        left: 0;
      }

      /* Fullpage container styles */
      #fullpage {
        height: 100vh;
        width: 100%;
        overflow: hidden;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
        margin: 0;
        padding: 0;
        /* Đảm bảo container không cao hơn viewport */
        max-height: 100vh;
      }

      /* Vertical scrolling (mặc định) */
      #fullpage.fp-vertical {
        height: 100vh;
      }

      .section {
        text-align: left;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        padding: 0;
        position: absolute;
        transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.6s ease, visibility 0.6s ease !important;
        will-change: transform, opacity;
        width: 100%;
        min-height: 100vh;
        height: 100vh;
        top: 0 !important;
        left: 0 !important;
        margin: 0 !important;
        box-sizing: border-box;
        overflow-y: auto;
        overflow-x: hidden;
        flex-shrink: 0;
        /* Mặc định: ẩn tất cả sections trừ active */
        opacity: 0 !important;
        visibility: hidden !important;
        pointer-events: none !important;
        z-index: 0;
        /* Đảm bảo background vẫn hiển thị ngay cả khi opacity = 0 */
        background-color: transparent;
        /* Đảm bảo background hiển thị */
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        /* KHÔNG dùng background-attachment: fixed vì nó conflict với transform */
      }

      /* Sections với class next hoặc prev - ẩn ngay từ đầu */
      .section.next,
      .section.prev {
        opacity: 0 !important;
        visibility: hidden !important;
        pointer-events: none !important;
      }

      /* Active section luôn hiển thị */
      .section.active {
        opacity: 1 !important;
        visibility: visible !important;
        display: flex !important;
        pointer-events: auto !important;
        z-index: 1 !important;
      }

      /* Đảm bảo content trong active section hiển thị - KHÔNG override display */
      .section.active > * {
        opacity: 1 !important;
        visibility: visible !important;
        width: 100% !important;
        padding: 2rem clamp(1rem, 4vw, 3rem) !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        /* KHÔNG set display ở đây - để components tự quyết định */
      }

      /* Đảm bảo tất cả children của components cũng hiển thị */
      .section.active > * > * {
        opacity: 1 !important;
        visibility: visible !important;
      }

      /* Đảm bảo components bên trong active section hiển thị đúng */
      .section.active .projects-section,
      .section.active .timeline-section,
      .section.active .card {
        opacity: 1 !important;
        visibility: visible !important;
        display: flex !important;
      }

      /* Vertical scrolling styles */
      #fullpage.fp-vertical .section {
        width: 100%;
        height: 100vh;
      }

      #fullpage.fp-vertical .section.active {
        transform: translateY(0) !important;
        z-index: 1 !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      }

      #fullpage.fp-vertical .section.prev {
        transform: translateY(-100%) !important;
        z-index: 0 !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }

      #fullpage.fp-vertical .section.next {
        transform: translateY(100%) !important;
        z-index: 0 !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }

      /* Elegant background colors cho từng section - tạo cảm giác trượt mượt mà */
      /* Section 1: Home */
      #fullpage .section {
        background: transparent !important;
        background-image: none !important;
      }

      /* Đảm bảo components bên trong có background trong suốt để gradient hiển thị */
      #fullpage .section[data-anchor="home"] {
        justify-content: center;
        align-items: center;
      }

      #fullpage .section[data-anchor="home"] .hero {
        background: rgba(255, 255, 255, 0.85) !important;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 0;
        box-shadow: none;
        margin: 0 auto;
        padding: 2rem;
        max-width: 1200px;
        width: 100%;
        min-height: auto !important;
        height: auto !important;
      }

      #fullpage .section[data-anchor^="du-an"] .projects-section {
        background: rgba(255, 255, 255, 0.85) !important;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 0;
        box-shadow: none;
        margin: 0;
        padding: 2rem;
        max-width: 100%;
        min-height: auto !important;
        height: auto !important;
      }

      #fullpage .section[data-anchor="kinh-nghiem"] .timeline-section,
      #fullpage .section[data-anchor="kinh-nghiem"] .timeline-section.alt {
        background: rgba(255, 255, 255, 0.85) !important;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 0;
        box-shadow: none;
        margin: 0;
        padding: 2rem;
        max-width: 100%;
        min-height: auto !important;
        height: auto !important;
        border: none !important;
      }

      #fullpage .section[data-anchor="lien-he"] .card {
        background: rgba(255, 255, 255, 0.85) !important;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 0;
        box-shadow: none;
        margin: 0;
        padding: 2rem;
        max-width: 100%;
        min-height: auto !important;
        height: auto !important;
      }

      /* Navigation dots */
      .fp-nav {
        position: fixed;
        right: 20px;
        top: 50%;
        transform: translateY(-50%) scale(0.8);
        z-index: 9999;
        list-style: none;
        margin: 0;
        padding: 0;
        opacity: 0.3;
        pointer-events: auto;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        will-change: opacity, transform;
      }

      .fp-nav.fp-nav-visible {
        opacity: 1;
        transform: translateY(-50%) scale(1);
        pointer-events: auto;
      }

      .fp-nav li {
        margin: 10px 0;
      }

      .fp-nav a {
        display: block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        border: 2px solid rgba(14, 165, 233, 0.6);
        transition: all 0.3s;
        cursor: pointer;
      }

      .fp-nav a.active,
      .fp-nav a:hover {
        background: var(--accent);
        transform: scale(1.2);
        border-color: var(--accent);
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      /* Mobile responsive tweaks */
      @media (max-width: 640px) {
        .section {
          height: 100vh;
          min-height: 100vh;
        }

        .section.active > * {
          padding: 1.25rem clamp(0.75rem, 4vw, 1.25rem) !important;
        }

        .fp-nav {
          right: 10px;
          transform: translateY(-50%) scale(0.7);
        }

        .fp-nav li {
          margin: 8px 0;
        }
      }
    </style>
  </head>
  <body>
    <LanguageSwitcher />
    <main>
      <slot />
    </main>
    <script is:inline define:vars={{ translationsVi, translationsEn }}>
      // Language switching client-side script
      (function() {
        const translations = {
          vi: translationsVi,
          en: translationsEn
        };

        // Update text content
        function updateTextContent(element, translations, path) {
          const keys = path.split('.');
          let value = translations;
          for (const key of keys) {
            if (value && typeof value === 'object') {
              // Handle array indices (numeric keys)
              const numKey = parseInt(key, 10);
              if (!isNaN(numKey) && Array.isArray(value)) {
                value = value[numKey];
              } else {
                value = value[key];
              }
            } else {
              return;
            }
          }
          
          if (typeof value === 'string') {
            element.textContent = value;
          }
        }

        // Update all translatable elements
        function updatePageContent(lang) {
          const langTranslations = translations[lang] || translations.vi;
          
          // Update HTML lang attribute
          document.documentElement.lang = lang;
          
          // Update elements with data-i18n attribute
          document.querySelectorAll('[data-i18n]').forEach(element => {
            const path = element.getAttribute('data-i18n');
            if (path) {
              updateTextContent(element, langTranslations, path);
            }
          });

          // Helper function to get translation value by path
          function getTranslationByPath(translations, path) {
            const keys = path.split('.');
            let value = translations;
            for (const key of keys) {
              if (value && typeof value === 'object') {
                const numKey = parseInt(key, 10);
                if (!isNaN(numKey) && Array.isArray(value)) {
                  value = value[numKey];
                } else {
                  value = value[key];
                }
              } else {
                return null;
              }
            }
            return typeof value === 'string' ? value : null;
          }

          // Update elements with data-i18n-attr (for attributes like alt, title, etc.)
          document.querySelectorAll('[data-i18n-attr]').forEach(element => {
            const attrData = element.getAttribute('data-i18n-attr');
            if (attrData) {
              try {
                const [attr, path] = attrData.split(':');
                const value = getTranslationByPath(langTranslations, path);
                
                if (value && attr) {
                  // Check if there's dynamic content path to fetch
                  const dynamicPath = element.getAttribute('data-i18n-dynamic-path');
                  const dynamicSuffix = element.getAttribute('data-i18n-dynamic-suffix') || '';
                  
                  if (dynamicPath) {
                    // Get the translated dynamic content
                    const dynamicValue = getTranslationByPath(langTranslations, dynamicPath);
                    if (dynamicValue) {
                      element.setAttribute(attr, `${value} ${dynamicValue}${dynamicSuffix}`);
                    } else {
                      element.setAttribute(attr, value);
                    }
                  } else {
                    // Check for old data-i18n-dynamic (static value) for backward compatibility
                    const dynamicContent = element.getAttribute('data-i18n-dynamic');
                    if (dynamicContent) {
                      element.setAttribute(attr, `${value} ${dynamicContent}${dynamicSuffix}`);
                    } else {
                      element.setAttribute(attr, value + dynamicSuffix);
                    }
                  }
                }
              } catch (e) {
                console.error('Error updating attribute:', e);
              }
            }
          });

          // Update elements with data-i18n-attr-title (for title attributes)
          document.querySelectorAll('[data-i18n-attr-title]').forEach(element => {
            const attrData = element.getAttribute('data-i18n-attr-title');
            if (attrData) {
              try {
                const [attr, path] = attrData.split(':');
                const value = getTranslationByPath(langTranslations, path);
                if (value && attr) {
                  element.setAttribute(attr, value);
                }
              } catch (e) {
                console.error('Error updating title attribute:', e);
              }
            }
          });

          // Save to localStorage
          localStorage.setItem('lang', lang);
          
          // Update URL without reload
          const url = new URL(window.location);
          url.searchParams.set('lang', lang);
          window.history.replaceState({}, '', url);
        }

        // Listen for language change events
        window.addEventListener('langchange', (e) => {
          const newLang = e.detail?.lang;
          if (newLang === 'vi' || newLang === 'en') {
            // Add fade transition
            document.body.style.transition = 'opacity 0.2s ease';
            document.body.style.opacity = '0.7';
            
            updatePageContent(newLang);
            
            // Update language switcher active state
            const switcher = document.getElementById('lang-switcher');
            if (switcher) {
              const options = switcher.querySelectorAll('.lang-option');
              options.forEach(opt => {
                if (opt.dataset.lang === newLang) {
                  opt.classList.add('active');
                } else {
                  opt.classList.remove('active');
                }
              });
            }
            
            // Fade back in
            setTimeout(() => {
              document.body.style.opacity = '1';
            }, 50);
          }
        });

        // Initialize on load - use server-rendered language
        const initialLang = document.documentElement.lang || 'vi';
        if (initialLang === 'vi' || initialLang === 'en') {
          // Update from localStorage if different
          const storedLang = localStorage.getItem('lang');
          const currentLang = (storedLang === 'vi' || storedLang === 'en') ? storedLang : initialLang;
          if (currentLang !== initialLang) {
            updatePageContent(currentLang);
          }
        }
      })();
    </script>
  </body>
  </html>
