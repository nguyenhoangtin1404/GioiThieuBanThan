---
import BaseLayout from '@layouts/BaseLayout.astro';
import Hero from '@components/Hero.astro';
import Projects from '@components/Projects.astro';
import Timeline from '@components/Timeline.astro';
import ContactCard from '@components/ContactCard.astro';
---

<BaseLayout
  title="Nguyễn Hoàng Tín"
  description="Backend/Fullstack Developer"
>
  <div id="fullpage">
    <!-- Section 1: Hero -->
    <div id="home" class="section active" data-anchor="home">
      <Hero />
    </div>

    <!-- Section 2: Project 1 -->
    <div id="du-an-1" class="section next" data-anchor="du-an-1">
      <Projects projectIndex={0} sectionId="du-an-1" title="D ¯ñ A­n 1" />
    </div>

    <!-- Section 3: Project 2 -->
    <div id="du-an-2" class="section next" data-anchor="du-an-2">
      <Projects projectIndex={1} sectionId="du-an-2" title="D ¯ñ A­n 2" />
    </div>

    <!-- Section 4: Project 3 -->
    <div id="du-an-3" class="section next" data-anchor="du-an-3">
      <Projects projectIndex={2} sectionId="du-an-3" title="D ¯ñ A­n 3" />
    </div>

    <!-- Section 5: Timeline -->
    <div id="kinh-nghiem" class="section next" data-anchor="kinh-nghiem">
      <Timeline />
    </div>

    <!-- Section 6: Contact -->
    <div id="lien-he" class="section next" data-anchor="lien-he">
      <ContactCard />
    </div>
  </div>

  <!-- Navigation dots -->
  <ul class="fp-nav">
    <li><a href="#home" data-index="0" class="active"></a></li>
    <li><a href="#du-an-1" data-index="1"></a></li>
    <li><a href="#du-an-2" data-index="2"></a></li>
    <li><a href="#du-an-3" data-index="3"></a></li>
    <li><a href="#kinh-nghiem" data-index="4"></a></li>
    <li><a href="#lien-he" data-index="5"></a></li>
  </ul>

  <!-- Load script từ public folder -->
  <script is:inline src="/js/vanilla-fullpage.js"></script>
  <script is:inline>
    // Options cấu hình
    const initOptions = {
      anchors: ['home', 'du-an-1', 'du-an-2', 'du-an-3', 'kinh-nghiem', 'lien-he'],
      navigation: true,
      scrollingSpeed: 800,
      loopBottom: true
    };

    const MOBILE_BREAKPOINT = 768;
    const anchors = ['home', 'du-an-1', 'du-an-2', 'du-an-3', 'kinh-nghiem', 'lien-he'];

    // Check if mobile
    function isMobile() {
      return window.innerWidth < MOBILE_BREAKPOINT;
    }

    // Setup mobile layout (normal scroll)
    function setupMobileLayout() {
      const fullpage = document.getElementById('fullpage');
      if (!fullpage) return;

      // Add mobile class to body for CSS
      document.body.classList.add('mobile-layout');

      // Show all sections
      const sections = fullpage.querySelectorAll('.section');
      sections.forEach((section) => {
        section.style.opacity = '1';
        section.style.visibility = 'visible';
        section.style.position = 'relative';
        section.style.height = 'auto';
        section.style.minHeight = 'auto';
        section.style.transform = 'none';
        section.style.pointerEvents = 'auto';
      });

      // Setup native smooth scroll for hash links
      const anchorLinks = document.querySelectorAll('a[href^="#"]');
      anchorLinks.forEach((link) => {
        link.addEventListener('click', (e) => {
          const href = link.getAttribute('href') || '';
          const target = href.replace('#', '');
          if (anchors.includes(target)) {
            const targetElement = document.getElementById(target);
            if (targetElement) {
              e.preventDefault();
              targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
              // Update URL hash
              window.history.pushState(null, '', href);
            }
          }
        });
      });

      // Handle hash on page load
      const hash = window.location.hash.replace('#', '');
      if (hash && anchors.includes(hash)) {
        setTimeout(() => {
          const targetElement = document.getElementById(hash);
          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100);
      }
    }

    // Destroy mobile layout (cleanup)
    function destroyMobileLayout() {
      document.body.classList.remove('mobile-layout');
      const sections = document.querySelectorAll('.section');
      sections.forEach((section) => {
        section.style.cssText = '';
      });
    }

    // Khởi tạo VanillaFullpage khi DOM ready và script đã load
    function initFullpage() {
      // Check if mobile - don't initialize fullpagejs on mobile
      if (isMobile()) {
        setupMobileLayout();
        return;
      }

      // Kiểm tra xem class đã được load chưa
      if (typeof VanillaFullpage === 'undefined') {
        // Nếu chưa load, thử lại sau 100ms
        setTimeout(initFullpage, 100);
        return;
      }

      try {
        // Khởi tạo VanillaFullpage
        window.vanillaFullpage = new VanillaFullpage('#fullpage', initOptions);

        // Gắn handler cho các anchor CTA để cuộn đúng section
        const anchorLinks = document.querySelectorAll('a[href^="#"]');
        anchorLinks.forEach((link) => {
          link.addEventListener('click', (e) => {
            const href = link.getAttribute('href') || '';
            const target = href.replace('#', '');
            const idx = anchors.indexOf(target);
            if (idx !== -1 && window.vanillaFullpage) {
              e.preventDefault();
              window.vanillaFullpage.goToSection(idx);
            }
          });
        });
      } catch (error) {
        console.error('Error initializing VanillaFullpage:', error);
        return;
      }

      // Xử lý hash URL khi trang load với hash (ví dụ: #lien-he)
      const hash = window.location.hash.replace('#', '');
      if (hash) {
        const index = anchors.indexOf(hash);
        if (index !== -1 && window.vanillaFullpage) {
          // Đợi một chút để đảm bảo fullpage đã khởi tạo xong
          setTimeout(() => {
            window.vanillaFullpage.goToSection(index);
          }, 100);
        }
      }
    }

    // Handle window resize
    let resizeTimeout;
    function handleResize() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const wasMobile = document.body.classList.contains('mobile-layout');
        const nowMobile = isMobile();

        if (wasMobile && !nowMobile) {
          // Resized from mobile to desktop
          destroyMobileLayout();
          if (typeof VanillaFullpage !== 'undefined' && !window.vanillaFullpage) {
            initFullpage();
          }
        } else if (!wasMobile && nowMobile) {
          // Resized from desktop to mobile
          if (window.vanillaFullpage) {
            // Destroy fullpagejs instance if possible
            if (window.vanillaFullpage.destroy) {
              window.vanillaFullpage.destroy();
            }
            window.vanillaFullpage = null;
          }
          setupMobileLayout();
        }
      }, 150);
    }

    // Khởi tạo khi DOM ready
    function init() {
      initFullpage();
      window.addEventListener('resize', handleResize);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      // Nếu DOM đã ready, đợi script load xong
      window.addEventListener('load', init);
      setTimeout(init, 50);
    }
  </script>
</BaseLayout>

